---
sidebar: sidebar 
permalink: openshift/os-dp-velero-migrate.html 
keywords: OpenShift, OCP, Trident, NetApp ONTAP, Red Hat OpenShift, OADP operator, Openshift Data Protection Application operator, Velero 
summary: Proteção de dados de aplicativos Red Hat OpenShift Container com NetApp ONTAP 
---
= Migrar um aplicativo de um cluster para outro
:hardbreaks:
:allow-uri-read: 
:nofooter: 
:icons: font
:linkattrs: 
:imagesdir: ../media/


[role="lead"]
Os recursos de backup e restauração do Velero o tornam uma ferramenta valiosa para migrar seus dados entre clusters.  Esta seção descreve como migrar aplicativos de um cluster para outro criando um backup do aplicativo no Armazenamento de objetos de um cluster e, em seguida, restaurando o aplicativo do mesmo armazenamento de objetos para outro cluster. .

.Backup do primeiro cluster
[%collapsible%open]
====
**Pré-requisitos no Cluster 1**

* O Trident deve ser instalado no cluster.
* Um backend trident e uma classe de armazenamento devem ser criados.
* O operador OADP deve ser instalado no cluster.
* O DataProtectionApplication deve ser configurado.


Use a seguinte especificação para configurar o objeto DataProtectionApplication.

....
spec:
  backupLocations:
    - velero:
        config:
          insecureSkipTLSVerify: 'false'
          profile: default
          region: us-east-1
          s3ForcePathStyle: 'true'
          s3Url: 'https://10.61.181.161'
        credential:
          key: cloud
          name: ontap-s3-credentials
        default: true
        objectStorage:
          bucket: velero
          caCert: <base-64 encoded tls certificate>
          prefix: container-backup
        provider: aws
  configuration:
    nodeAgent:
      enable: true
      uploaderType: kopia
    velero:
      defaultPlugins:
        - csi
        - openshift
        - aws
        - kubevirt
....
* Crie um aplicativo no cluster e faça um backup desse aplicativo.  Por exemplo, instale um aplicativo postgres.


image:redhat-openshift-oadp-migrate-001.png["instalar aplicativo postgres"]

* Use a seguinte especificação para o CR de backup:


....
spec:
  csiSnapshotTimeout: 10m0s
  defaultVolumesToFsBackup: false
  includedNamespaces:
    - postgresql
  itemOperationTimeout: 4h0m0s
  snapshotMoveData: true
  storageLocation: velero-sample-1
  ttl: 720h0m0s
....
image:redhat-openshift-oadp-migrate-002.png["instalar aplicativo postgres"]

Você pode clicar na aba **Todas as instâncias** para ver os diferentes objetos sendo criados e passando por diferentes fases até finalmente chegar à fase de backup **concluído**.

Um backup dos recursos no namespace postgresql será armazenado no local de armazenamento de objetos (ONTAP S3) especificado em backupLocation na especificação OADP.

====
.Restaurar para um segundo cluster
[%collapsible%open]
====
**Pré-requisitos no Cluster 2**

* O Trident deve ser instalado no cluster 2.
* O aplicativo postgresql NÃO deve estar instalado no namespace postgresql.
* O operador OADP deve ser instalado no cluster 2, e o BackupStorage Location deve apontar para o mesmo local de armazenamento de objetos onde o backup foi armazenado do primeiro cluster.
* O CR de backup deve estar visível no segundo cluster.


image:redhat-openshift-oadp-migrate-003.png["tridente instalado"]

image:redhat-openshift-oadp-migrate-004.png["postgres ainda não instalado"]

image:redhat-openshift-oadp-migrate-005.png["OADP instalado no cluster 2"]

image:redhat-openshift-oadp-migrate-006.png["local de armazenamento de backup apontando para o mesmo armazenamento de objetos"]

Restaure o aplicativo neste cluster a partir do backup.  Use o seguinte yaml para criar o Restore CR.

....
apiVersion: velero.io/v1
kind: Restore
apiVersion: velero.io/v1
metadata:
  name: restore
  namespace: openshift-adp
spec:
  backupName: backup
  restorePVs: true
....
Quando a restauração estiver concluída, você verá que o aplicativo postgresql está em execução neste cluster e está associado ao pvc e a um pv correspondente.  O estado do aplicativo é o mesmo de quando o backup foi feito.

image:redhat-openshift-oadp-migrate-007.png["restaurar o sucesso"]

image:redhat-openshift-oadp-migrate-008.png["postgres migrado"]

====